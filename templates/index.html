<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEAF DSS - Landscape Evaluation & Assessment Framework</title>
    <link rel="icon" href="https://www.iwmi.org/wp-content/uploads/2025/06/iwmi-favicon-512x512-1.png">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo-section" style="text-decoration:none;color:inherit">
                <img src="{{ url_for('static', filename='images/iwmi_logo.png') }}" alt="IWMI Logo" class="logo" onerror="this.style.display='none'">
                <div class="title-section">
                    <h1>LEAF DSS</h1>
                    <p>Landscape Evaluation & Assessment Framework</p>
                </div>
            </a>
            <div class="logo-section">
                <img src="{{ url_for('static', filename='giz_logo.jpg') }}" alt="GIZ Logo" class="logo giz-logo" onerror="this.style.display='none'">
                <img src="{{ url_for('static', filename='images/cgiar_logo.png') }}" alt="CGIAR Logo" class="logo" onerror="this.style.display='none'">
            </div>
        </div>
    </header>

    <!-- Filter Bar -->
    <div class="filter-bar">
        <div class="filter-group">
            <label for="district-select">District</label>
            <select id="district-select">
                <option value="">All Districts</option>
            </select>
        </div>

        <div class="filter-group" id="block-filter-group">
            <label for="block-select">Block</label>
            <select id="block-select">
                <option value="">All Blocks</option>
            </select>
        </div>

        <div class="filter-group" id="gp-filter-group" style="display: none;">
            <label for="gp-select">Gram Panchayat</label>
            <select id="gp-select">
                <option value="">Select GP (or All)</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="intervention-select">Intervention</label>
            <select id="intervention-select">
                <option value="">Select Intervention</option>
                {% for key, val in interventions.items() %}
                <option value="{{ key }}">{{ val.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label>Logic</label>
            <div class="logic-toggle">
                <button id="logic-and" class="logic-btn active">AND</button>
                <button id="logic-or" class="logic-btn">OR</button>
            </div>
        </div>

        <div class="filter-group">
            <button id="configure-btn" class="btn-primary"><i class="bi bi-sliders"></i> Configure</button>
        </div>

        <div class="filter-group">
            <button id="export-btn" class="btn-export"><i class="bi bi-download"></i> CSV</button>
        </div>
    </div>

    <!-- Add Variable Modal -->
    <div id="add-variable-modal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2>Add Variable</h2>
                <button id="add-var-modal-close" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="search-box">
                    <i class="bi bi-search"></i>
                    <input type="text" id="variable-search" placeholder="Search variables...">
                </div>
                <div class="variable-list" id="variable-list">
                    <!-- Dynamic variable list -->
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Modal -->
    <div id="config-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Configuration</h2>
                <button id="modal-close" class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="config-form">
                <!-- Dynamic content loaded here -->
            </div>
            <div class="modal-footer">
                <button id="add-variable-btn" class="btn-add"><i class="bi bi-plus-lg"></i> Add Variable</button>
                <button id="apply-config" class="btn-primary"><i class="bi bi-check-lg"></i> Apply</button>
                <button id="cancel-config" class="btn-secondary"><i class="bi bi-x-lg"></i> Cancel</button>
            </div>
        </div>
    </div>

    <!-- AI Recommendation Modal -->
    <div id="ai-modal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2><i class="bi bi-robot"></i> Recommendations</h2>
                <div class="modal-header-actions">
                    <button id="ai-copy-btn" class="modal-action-btn" title="Copy to clipboard" onclick="copyAIRecommendation()">
                        <i class="bi bi-clipboard"></i>
                    </button>
                    <button id="ai-download-btn" class="modal-action-btn" title="Download as PDF" onclick="downloadAIRecommendation()">
                        <i class="bi bi-download"></i>
                    </button>
                    <button id="ai-modal-close" class="modal-close">&times;</button>
                </div>
            </div>
            <div class="modal-body" id="ai-modal-body">
                <div class="ai-loading-state">
                    <i class="bi bi-robot ai-spin"></i>
                    <p>Analyzing policy documents and generating recommendations...</p>
                </div>
            </div>
            <div class="modal-footer" id="ai-modal-footer" style="display: none;">
                <div class="ai-sources-section">
                    <h4><i class="bi bi-journal-text"></i> Reference Documents</h4>
                    <div id="ai-source-links"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overview View (Default) -->
    <main id="overviewView" class="main-content">
        <!-- Map Section (Left) -->
        <section class="map-section">
            <div class="map-header">
                <h3><i class="bi bi-map"></i> Feasibility Map</h3>
                <div class="legend-items" id="map-legend">
                    <!-- Dynamic legend loaded by JS -->
                </div>
            </div>
            <div id="map"></div>
        </section>

        <!-- Distribution Section (Middle) -->
        <section class="distribution-section">
            <h3><i class="bi bi-pie-chart"></i> Distribution</h3>
            <div class="chart-container">
                <canvas id="distribution-chart"></canvas>
            </div>
            <div class="chart-legend" id="chart-legend">
                <!-- Dynamic legend loaded by JS -->
            </div>
        </section>

        <!-- Filters Section (Right) -->
        <section class="filters-section">
            <div id="active-filters">
                <p class="no-filters">Select an intervention to see filters</p>
            </div>
        </section>
    </main>

    <!-- Block Detail View (Hidden by default) -->
    <main id="blockDetailView" class="block-detail-view" style="display: none;">
        <!-- Header with Back Button -->
        <div class="block-detail-header">
            <div class="header-top-row">
                <a href="#" id="back-to-overview" class="back-link">
                    <i class="bi bi-arrow-left"></i> Overview
                </a>
                <div class="recommendation-line" id="block-recommendations">
                    <!-- Dynamic recommendation -->
                </div>
                <div id="feasibility-badges" class="feasibility-badges">
                    <!-- Feasibility status badge -->
                </div>
            </div>
        </div>

        <!-- Block Detail Grid -->
        <div class="block-detail-grid">
            <!-- Location Card with Mini Map -->
            <div class="detail-card">
                <div class="detail-card-header">
                    <span><i class="bi bi-geo-alt"></i> <span id="location-card-title">Location</span></span>
                    <div class="header-right-group">
                        <select id="block-gp-select" class="block-gp-dropdown" style="display: none;">
                            <option value="">All GPs</option>
                        </select>
                        <span class="outside-count" id="total-outside-count"></span>
                    </div>
                </div>
                <div class="detail-card-body">
                    <div id="block-mini-map" class="mini-map"></div>
                </div>
            </div>

            <!-- Land & Agriculture Card -->
            <div class="detail-card" id="card-land-agri">
                <div class="detail-card-header">
                    <span><i class="bi bi-flower2"></i> Land & Agriculture</span>
                    <span class="outside-count" id="count-land-agri"></span>
                </div>
                <div class="detail-card-body" id="land-agri-metrics">
                    <!-- Dynamic metrics -->
                </div>
            </div>

            <!-- Water Card -->
            <div class="detail-card" id="card-water">
                <div class="detail-card-header">
                    <span><i class="bi bi-droplet"></i> Water</span>
                    <span class="outside-count" id="count-water"></span>
                </div>
                <div class="detail-card-body" id="water-metrics">
                    <!-- Dynamic metrics -->
                </div>
            </div>

            <!-- Infrastructure Card -->
            <div class="detail-card" id="card-infrastructure">
                <div class="detail-card-header">
                    <span><i class="bi bi-building"></i> Infrastructure</span>
                    <span class="outside-count" id="count-infrastructure"></span>
                </div>
                <div class="detail-card-body" id="infrastructure-metrics">
                    <!-- Dynamic metrics -->
                </div>
            </div>

            <!-- Livestock Card -->
            <div class="detail-card" id="card-livestock">
                <div class="detail-card-header">
                    <span><i class="bi bi-piggy-bank"></i> Livestock</span>
                    <span class="outside-count" id="count-livestock"></span>
                </div>
                <div class="detail-card-body" id="livestock-metrics">
                    <!-- Dynamic metrics -->
                </div>
            </div>

            <!-- People & Collectives Card -->
            <div class="detail-card" id="card-people">
                <div class="detail-card-header">
                    <span><i class="bi bi-people"></i> People & Collectives</span>
                    <span class="outside-count" id="count-people"></span>
                </div>
                <div class="detail-card-body" id="people-metrics">
                    <!-- Dynamic metrics -->
                </div>
            </div>
        </div>
    </main>

    <!-- GP Detail View (Hidden by default) -->
    <main id="gpDetailView" class="block-detail-view" style="display: none;">
        <!-- Header with Back Button -->
        <div class="block-detail-header">
            <div class="header-top-row">
                <a href="#" id="back-to-overview-gp" class="back-link">
                    <i class="bi bi-arrow-left"></i> Overview
                </a>
                <div class="recommendation-line" id="gp-recommendations">
                    <!-- Dynamic recommendation -->
                </div>
                <div id="gp-feasibility-badges" class="feasibility-badges">
                    <!-- Feasibility status badge -->
                </div>
            </div>
        </div>

        <!-- GP Detail Grid -->
        <div class="block-detail-grid">
            <!-- Location Card with Mini Map -->
            <div class="detail-card">
                <div class="detail-card-header">
                    <span><i class="bi bi-geo-alt"></i> <span id="gp-location-title">GP Location</span></span>
                </div>
                <div class="detail-card-body">
                    <div id="gp-mini-map" class="mini-map"></div>
                    <div id="gp-basic-info" class="gp-basic-info">
                        <!-- Village count etc -->
                    </div>
                </div>
            </div>

            <!-- Livestock Density Card -->
            <div class="detail-card" id="card-gp-livestock-density">
                <div class="detail-card-header">
                    <span><i class="bi bi-bar-chart"></i> Livestock Density</span>
                </div>
                <div class="detail-card-body" id="gp-livestock-density-metrics">
                    <!-- Dynamic metrics -->
                </div>
            </div>

            <!-- Livestock Services Card -->
            <div class="detail-card" id="card-gp-livestock-services">
                <div class="detail-card-header">
                    <span><i class="bi bi-heart-pulse"></i> Livestock Services</span>
                </div>
                <div class="detail-card-body" id="gp-livestock-services-metrics">
                    <!-- Dynamic metrics -->
                </div>
            </div>

            <!-- Transport & Connectivity Card -->
            <div class="detail-card" id="card-gp-transport">
                <div class="detail-card-header">
                    <span><i class="bi bi-truck"></i> Transport & Connectivity</span>
                </div>
                <div class="detail-card-body" id="gp-transport-metrics">
                    <!-- Dynamic metrics -->
                </div>
            </div>

            <!-- Finance & Markets Card -->
            <div class="detail-card" id="card-gp-finance">
                <div class="detail-card-header">
                    <span><i class="bi bi-bank"></i> Finance & Markets</span>
                </div>
                <div class="detail-card-body" id="gp-finance-metrics">
                    <!-- Dynamic metrics -->
                </div>
            </div>

            <!-- Utilities Card -->
            <div class="detail-card" id="card-gp-utilities">
                <div class="detail-card-header">
                    <span><i class="bi bi-lightning"></i> Utilities</span>
                </div>
                <div class="detail-card-body" id="gp-utilities-metrics">
                    <!-- Dynamic metrics -->
                </div>
            </div>

            <!-- Land & Agriculture Card -->
            <div class="detail-card" id="card-gp-land">
                <div class="detail-card-header">
                    <span><i class="bi bi-flower2"></i> Land & Agriculture</span>
                </div>
                <div class="detail-card-body" id="gp-land-metrics">
                    <!-- Dynamic metrics -->
                </div>
            </div>

            <!-- Activities Card -->
            <div class="detail-card" id="card-gp-activities">
                <div class="detail-card-header">
                    <span><i class="bi bi-activity"></i> Activities</span>
                </div>
                <div class="detail-card-body" id="gp-activities-metrics">
                    <!-- Dynamic metrics -->
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <p>LEAF DSS | IWMI - International Water Management Institute</p>
    </footer>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Initial State from URL -->
    <script>
        window.INITIAL_STATE = {
            level: '{{ initial_level | default("") }}',
            district: '{{ initial_district | default("") }}',
            block: '{{ initial_block | default("") }}',
            gp: '{{ initial_gp | default("") }}'
        };
    </script>

    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
